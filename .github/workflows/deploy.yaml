name: CD - ECS Blue Green Deploy (Manual)

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Docker image tag to deploy"
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      ################################
      # Checkout
      ################################
      - name: Checkout repository
        uses: actions/checkout@v4

      ################################
      # AWS Credentials
      ################################
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ secrets.AWS_REGION }}

      ################################
      # Register New Task Definition
      ################################
      - name: Register ECS task definition
        id: taskdef
        run: |
          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --family sandeep-strapi-task \
            --network-mode awsvpc \
            --requires-compatibilities FARGATE \
            --cpu "512" \
            --memory "1024" \
            --execution-role-arn arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/sandeep-ecs-task-execution-role \
            --container-definitions '[
              {
                "name": "strapi",
                "image": "'"${{ secrets.ECR_REPO }}:${{ github.event.inputs.image_tag }}"'",
                "portMappings": [{ "containerPort": 1337 }],
                "environment": [
                  { "name": "NODE_ENV", "value": "production" },
                  { "name": "APP_KEYS", "value": "'"${{ secrets.APP_KEYS }}"'" },
                  { "name": "ADMIN_JWT_SECRET", "value": "'"${{ secrets.ADMIN_JWT_SECRET }}"'" },
                  { "name": "JWT_SECRET", "value": "'"${{ secrets.JWT_SECRET }}"'" },
                  { "name": "API_TOKEN_SALT", "value": "'"${{ secrets.API_TOKEN_SALT }}"'" },
                  { "name": "DATABASE_CLIENT", "value": "postgres" },
                  { "name": "DATABASE_HOST", "value": "'"${{ secrets.DB_HOST }}"'" },
                  { "name": "DATABASE_PORT", "value": "5432" },
                  { "name": "DATABASE_NAME", "value": "'"${{ secrets.DB_NAME }}"'" },
                  { "name": "DATABASE_USERNAME", "value": "'"${{ secrets.DB_USERNAME }}"'" },
                  { "name": "DATABASE_PASSWORD", "value": "'"${{ secrets.DB_PASSWORD }}"'" }
                ],
                "logConfiguration": {
                  "logDriver": "awslogs",
                  "options": {
                    "awslogs-group": "/ecs/sandeep-strapi",
                    "awslogs-region": "${{ secrets.AWS_REGION }}",
                    "awslogs-stream-prefix": "ecs"
                  }
                }
              }
            ]' \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          echo "TASK_DEF_ARN=$TASK_DEF_ARN" >> $GITHUB_ENV

      ################################
      # Create CodeDeploy Deployment
      ################################
      - name: Deploy using CodeDeploy (Blue/Green)
        run: |
          sed "s|<TASK_DEFINITION>|$TASK_DEF_ARN|g" appspec.yaml > appspec-final.yaml

          aws deploy create-deployment \
            --application-name sandeep-strapi-codedeploy \
            --deployment-group-name sandeep-strapi-dg \
            --revision revisionType=AppSpecContent,appSpecContent="{content=$(cat appspec-final.yaml)}"
