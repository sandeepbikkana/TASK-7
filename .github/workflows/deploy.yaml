name: CD - ECS Blue Green Deploy (Manual)

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Docker image tag to deploy"
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ secrets.AWS_REGION }}

      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.0

      - name: Terraform init
        working-directory: terraform
        run: terraform init -input=false

      - name: Read RDS endpoint
        working-directory: terraform
        run: |
          echo "DB_HOST=$(terraform output -raw rds_endpoint)" >> $GITHUB_ENV

      - name: Create container definition
        run: |
          cat <<EOF > container-def.json
          [
            {
              "name": "strapi",
              "image": "${{ secrets.ECR_REPO }}:${{ github.event.inputs.image_tag }}",
              "essential": true,
              "portMappings": [{ "containerPort": 1337 }],
              "environment": [
                { "name": "NODE_ENV", "value": "production" },
                { "name": "DATABASE_CLIENT", "value": "postgres" },
                { "name": "DATABASE_HOST", "value": "$DB_HOST" },
                { "name": "DATABASE_PORT", "value": "5432" },
                { "name": "DATABASE_NAME", "value": "strapi" },
                { "name": "DATABASE_USERNAME", "value": "${{ secrets.DB_USERNAME }}" },
                { "name": "DATABASE_PASSWORD", "value": "${{ secrets.DB_PASSWORD }}" }
              ]
            }
          ]
          EOF

      - name: Register task definition
        run: |
          TASK_DEF=$(aws ecs register-task-definition \
            --family sandeep-strapi-task \
            --requires-compatibilities FARGATE \
            --network-mode awsvpc \
            --cpu 512 \
            --memory 1024 \
            --execution-role-arn arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/sandeep-ecs-task-execution-role \
            --container-definitions file://container-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)
          echo "TASK_DEF=$TASK_DEF" >> $GITHUB_ENV

      - name: Deploy via CodeDeploy
        run: |
          sed "s|<TASK_DEFINITION>|$TASK_DEF|g" appspec.yaml > appspec-final.yaml
          aws deploy create-deployment \
            --application-name sandeep-strapi-codedeploy \
            --deployment-group-name sandeep-strapi-dg \
            --revision revisionType=AppSpecContent,appSpecContent="{content=$(cat appspec-final.yaml)}"



