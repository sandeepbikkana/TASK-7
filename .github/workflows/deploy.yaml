name: TASK-11 - ECS Blue Green Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: ap-south-1
      IMAGE_TAG: ${{ github.sha }}

    steps:
      ################################
      # Checkout
      ################################
      - name: Checkout repository
        uses: actions/checkout@v4

      ################################
      # Configure AWS Credentials
      ################################
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v3
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      ################################
      # Login to Amazon ECR
      ################################
      - name: Login to Amazon ECR
        run: |
          aws ecr get-login-password --region $AWS_REGION \
          | docker login --username AWS --password-stdin ${{ secrets.ECR_REGISTRY }}

      ################################
      # Build & Push Docker Image
      ################################
      - name: Build and push Docker image
        run: |
          docker build -t ${{ secrets.ECR_REPO }}:$IMAGE_TAG .
          docker push ${{ secrets.ECR_REPO }}:$IMAGE_TAG

      ################################
      # Register New ECS Task Definition
      ################################
      - name: Register ECS task definition
        id: taskdef
        run: |
          cat <<EOF > container-def.json
          [
            {
              "name": "strapi",
              "image": "${{ secrets.ECR_REPO }}:$IMAGE_TAG",
              "essential": true,
              "portMappings": [{ "containerPort": 1337 }],
              "environment": [
                { "name": "DATABASE_HOST", "value": "${{ secrets.DATABASE_HOST }}" },
                { "name": "DATABASE_PORT", "value": "5432" },
                { "name": "DATABASE_NAME", "value": "strapi" },
                { "name": "DATABASE_USERNAME", "value": "${{ secrets.DB_USERNAME }}" },
                { "name": "DATABASE_PASSWORD", "value": "${{ secrets.DB_PASSWORD }}" }
              ]
            }
          ]
          EOF

          TASK_DEF_ARN=$(aws ecs register-task-definition \
            --family sandeep-strapi-task \
            --network-mode awsvpc \
            --requires-compatibilities FARGATE \
            --cpu 512 \
            --memory 1024 \
            --execution-role-arn arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/sandeep-ecs-task-execution-role \
            --container-definitions file://container-def.json \
            --query 'taskDefinition.taskDefinitionArn' \
            --output text)

          echo "task_def_arn=$TASK_DEF_ARN" >> $GITHUB_OUTPUT

      ################################
      # Create AppSpec File
      ################################
      - name: Create AppSpec
        run: |
          cat <<EOF > appspec.yaml
          version: 1
          Resources:
            - TargetService:
                Type: AWS::ECS::Service
                Properties:
                  TaskDefinition: ${{ steps.taskdef.outputs.task_def_arn }}
                  LoadBalancerInfo:
                    ContainerName: strapi
                    ContainerPort: 1337
          EOF

      ################################
      # Trigger CodeDeploy Deployment
      ################################
      - name: Trigger CodeDeploy deployment
        id: deploy
        run: |
          DEPLOYMENT_ID=$(aws deploy create-deployment \
            --application-name sandeep-strapi-codedeploy \
            --deployment-group-name sandeep-strapi-dg \
            --revision revisionType=AppSpecContent,appSpecContent="{content=$(cat appspec.yaml)}" \
            --query deploymentId \
            --output text)

          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_OUTPUT

      ################################
      # Monitor Deployment & Rollback
      ################################
      - name: Wait for deployment to complete
        run: |
          aws deploy wait deployment-successful \
            --deployment-id ${{ steps.deploy.outputs.deployment_id }}

